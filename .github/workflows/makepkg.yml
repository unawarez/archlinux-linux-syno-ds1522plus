name: makepkg
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base-devel
    steps:
      - name: Bootstrap pacman
        run: |
          pacman-key --init
          pacman -Syu --noconfirm
      - name: Create build user
        run: |
          useradd user
          echo 'user ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
      - name: Get upstream PGP keys
        run: sudo -u user gpg --recv-keys ABAF11C65A2970B130ABE3C479BE3E4300411886  647F28654894E3BD457199BE38DBBDC86092693E A2FF3A36AAA56654109064AB19802F8B0D70FC30
      - name: Clone repo
        uses: actions/checkout@v4
      # based on dumb experiments, cwd here is /__w/blabla/... the full checkout dir,
      # and github.workspace is completely wrong and doesn't exist.
      - name: Chown repo to build user
        run: chown --recursive user .
      - name: Run makepkg
        run: sudo -u user makepkg -s --noconfirm
